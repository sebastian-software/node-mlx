# Generated Code

⚠️ **DO NOT EDIT FILES IN THIS DIRECTORY MANUALLY** ⚠️

All files are auto-generated by `hf2swift` and will be overwritten.

## Models

| Model    | File                      | HuggingFace Type | Features                     |
| -------- | ------------------------- | ---------------- | ---------------------------- |
| Llama    | `LlamaGenerated.swift`    | `llama`          | Standard (shared components) |
| Phi-3    | `Phi3Generated.swift`     | `phi3`           | Fused QKV                    |
| Qwen2    | `Qwen2Generated.swift`    | `qwen2`          | Standard (shared components) |
| Qwen3    | `Qwen3Generated.swift`    | `qwen3`          | Q/K norms                    |
| Gemma3   | `Gemma3Generated.swift`   | `gemma3`         | 4 norms, Gemma RMSNorm       |
| Gemma3n  | `Gemma3nGenerated.swift`  | `gemma3n`        | AltUp, Laurel, VLM           |
| Mistral  | `MistralGenerated.swift`  | `mistral`        | Sliding window               |
| Mistral3 | `Mistral3Generated.swift` | `mistral3`       | YaRN RoPE                    |
| SmolLM3  | `SmolLM3Generated.swift`  | `smollm3`        | No-RoPE layers               |
| GPT-OSS  | `GptOSSGenerated.swift`   | `gpt_oss`        | MoE, attention sinks         |

## Regenerating Models

### Single Model

```bash
pnpm hf2swift --model llama --output packages/swift/Sources/NodeMLXCore/generated/models/LlamaGenerated.swift
```

### All Models (Automatic)

The pre-push hook automatically regenerates all models:

```bash
git push  # Regenerates and validates all models
```

### Manual Regeneration

```bash
cd packages/hf2swift
for model in llama qwen2 qwen3 mistral mistral3 phi3 gemma3 gemma3n smollm3 gpt_oss; do
  pnpm tsx src/cli.ts --model $model --output ../swift/Sources/NodeMLXCore/generated/models/<Model>Generated.swift
done
```

## Generator Source

The generator is at `packages/hf2swift/`:

```
hf2swift/src/generator/
├── model-defs/           # Model family definitions
│   ├── llama.ts          # Llama architectural features
│   ├── qwen.ts           # Qwen2, Qwen3
│   ├── gemma.ts          # Gemma3, Gemma3n
│   └── ...
├── components/           # Code generators
│   ├── attention.ts      # Attention layer
│   ├── mlp.ts            # MLP layer
│   ├── decoder-layer.ts  # Decoder layer
│   └── model.ts          # Model wrapper
└── features.ts           # Feature merging logic
```

## How Generation Works

1. **Feature detection**: Determine architectural features from model type
2. **Component selection**: Choose shared vs. custom implementation per component
3. **Code generation**: Produce Swift code
4. **SwiftFormat**: Apply consistent formatting

### Simple Models (Llama, Qwen2)

Use shared components via typealiases:

```swift
typealias LlamaAttention = StandardAttention<LlamaConfiguration>
typealias LlamaMLP = StandardMLP<LlamaConfiguration>
typealias LlamaDecoderLayer = StandardDecoderLayer<LlamaConfiguration>
```

Result: ~195 lines of generated code

### Complex Models (Gemma3n, GPT-OSS)

Generate custom implementations:

```swift
class Gemma3nAttention: Module {
    // Full custom implementation with Q/K/V norms, sliding window, etc.
}
```

Result: ~700+ lines of generated code

## Validation

Generated files are validated on every push:

1. Pre-push hook regenerates all models
2. Compares against committed versions
3. Fails if any differences detected
4. Ensures generator and generated code stay in sync

## Adding a New Model

1. Create `model-defs/<model>.ts`:

   ```typescript
   export const myModel: ModelDefinition = {
     name: "MyModel",
     matches: (t) => t.includes("mymodel"),
     architectural: { ...DEFAULT_ARCHITECTURAL, activation: "silu" },
     configDefaults: { ...DEFAULT_CONFIG, ropeTheta: 50000 }
   }
   ```

2. Register in `model-defs/index.ts`

3. Generate:

   ```bash
   pnpm hf2swift --model mymodel --output .../MyModelGenerated.swift
   ```

4. Add to pre-push hook model list
