#!/bin/sh

echo "üîç Running pre-push checks..."

# TypeScript/JavaScript linting
echo "‚Üí ESLint..."
pnpm lint || {
  echo "‚ùå ESLint failed. Fix errors before pushing."
  exit 1
}

# TypeScript type checking
echo "‚Üí TypeScript..."
pnpm typecheck || {
  echo "‚ùå TypeScript errors. Fix before pushing."
  exit 1
}

# Regenerate Swift models and check for uncommitted changes
echo "‚Üí Regenerating Swift models..."
MODELS_DIR="packages/swift/Sources/NodeMLXCore/generated/models"

# List of models that ARE auto-generated
GENERATED_MODELS=(
  "qwen2:Qwen2Generated.swift"
  "qwen3:Qwen3Generated.swift"
  "llama:LlamaGenerated.swift"
  "phi3:Phi3Generated.swift"
  "gemma3:Gemma3Generated.swift"
  "gemma3n:Gemma3nGenerated.swift"
  "mistral:MistralGenerated.swift"
  "mistral3:Mistral3Generated.swift"
  "smollm3:SmolLM3Generated.swift"
  "gpt_oss:GptOSSGenerated.swift"
)

# Build hf2swift first
pnpm --filter @node-mlx/hf2swift build --silent 2>/dev/null || {
  echo "‚ö†Ô∏è Could not build hf2swift, skipping model regeneration check"
}

# Check if hf2swift is available
if [ -f "packages/hf2swift/dist/cli.js" ]; then
  for entry in "${GENERATED_MODELS[@]}"; do
    model="${entry%%:*}"
    output="${entry##*:}"

    # Regenerate model (swiftformat is already called by the generator)
    node packages/hf2swift/dist/cli.js --model "$model" --output "$MODELS_DIR/$output" 2>/dev/null
  done

  # Ensure consistent formatting with swiftformat (same as lint-staged)
  if command -v swiftformat &> /dev/null; then
    swiftformat "$MODELS_DIR" --quiet 2>/dev/null || true
  fi

  # Check if any generated files changed
  if ! git diff --quiet "$MODELS_DIR"/*Generated.swift 2>/dev/null; then
    echo "‚ùå Generated Swift models are out of sync!"
    echo ""
    echo "The following generated files have uncommitted changes:"
    git diff --name-only "$MODELS_DIR"/*Generated.swift
    echo ""
    echo "Either commit the regenerated files, or update the hf2swift generator"
    echo "and regenerate with: pnpm hf2swift --model <name> --output <path>"
    exit 1
  fi
fi

# Swift format check (if swift files changed)
if git diff --cached --name-only origin/main 2>/dev/null | grep -q '\.swift$'; then
  echo "‚Üí SwiftFormat check..."
  cd packages/swift
  if command -v swiftformat &> /dev/null; then
    swiftformat Sources Tests --lint 2>/dev/null || {
      echo "‚ùå SwiftFormat issues found. Run 'swiftformat .' to fix."
      exit 1
    }
  fi
  cd ../..
fi

echo "‚úÖ All pre-push checks passed!"
